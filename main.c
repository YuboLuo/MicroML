/**
 * Library to interact with an HM-10 Bluetooth Module.
 */
#include "main.h"

#define MAX_STEPS 100
//#define BUDGET 9  // Energy Budget in mW. This is Total Budget / (sample rate * total budget * seq_length)
#define MILLI_FACTOR 1000
#define SAMPLE_RATE 2  // Sample period (1 / freq)

// Variable to track ADC conversion
volatile int16_t nAdc;


// Allocate memory for input features
static matrix inputFeatures, outputLabels;

// test input image
#pragma PERSISTENT(array)
static dtype array[3072] = {634, 638, 662, 666, 642, 626, 650, 638, 634, 638, 646, 642, 646, 666, 678, 682, 670, 650, 642, 642, 626, 598, 602, 594, 598, 574, 562, 566, 574, 550, 505, 465, 610, 606, 638, 666, 650, 642, 658, 650, 654, 626, 622, 638, 654, 682, 686, 686, 678, 642, 618, 606, 582, 558, 562, 566, 598, 590, 582, 570, 574, 546, 501, 477, 606, 606, 634, 670, 642, 654, 662, 662, 654, 650, 634, 630, 646, 666, 670, 678, 682, 638, 582, 485, 441, 393, 405, 457, 481, 538, 574, 562, 570, 558, 522, 481, 622, 622, 642, 698, 670, 670, 678, 678, 662, 662, 670, 766, 710, 630, 650, 658, 634, 598, 417, 413, 393, 369, 321, 297, 345, 333, 453, 530, 562, 562, 546, 509, 622, 626, 646, 682, 678, 654, 678, 666, 658, 658, 694, 987, 783, 606, 586, 570, 445, 313, 341, 453, 449, 425, 389, 373, 297, 337, 341, 421, 514, 554, 534, 518, 594, 534, 522, 590, 646, 662, 670, 670, 654, 662, 654, 722, 630, 514, 389, 265, 277, 265, 357, 473, 489, 477, 457, 377, 397, 365, 232, 269, 433, 562, 554, 538, 509, 437, 188, 353, 614, 682, 674, 682, 678, 666, 658, 590, 518, 509, 401, 273, 313, 289, 333, 530, 586, 497, 421, 429, 461, 341, 252, 184, 317, 530, 566, 538, 526, 397, 168, 281, 574, 670, 662, 674, 686, 646, 562, 481, 522, 578, 465, 353, 365, 341, 309, 497, 654, 546, 409, 425, 401, 341, 216, 196, 228, 429, 554, 546, 682, 413, 216, 497, 614, 646, 654, 666, 662, 698, 453, 501, 630, 626, 485, 345, 329, 337, 321, 325, 554, 586, 453, 349, 333, 345, 285, 224, 160, 297, 534, 550, 722, 538, 377, 618, 698, 634, 626, 614, 831, 951, 831, 626, 698, 594, 501, 373, 345, 297, 236, 305, 550, 574, 534, 425, 345, 349, 337, 301, 200, 160, 381, 530, 734, 433, 570, 662, 710, 622, 638, 489, 855, 951, 883, 658, 734, 626, 501, 481, 313, 321, 180, 365, 702, 630, 622, 429, 349, 413, 353, 313, 236, 164, 236, 417, 754, 401, 542, 682, 750, 666, 694, 538, 469, 779, 799, 682, 742, 758, 538, 469, 409, 337, 152, 501, 843, 642, 586, 373, 333, 377, 417, 341, 293, 220, 248, 305, 758, 361, 509, 702, 698, 666, 714, 638, 389, 674, 674, 550, 746, 867, 642, 493, 481, 461, 200, 602, 779, 622, 493, 365, 337, 337, 381, 345, 337, 293, 317, 293, 758, 373, 610, 742, 477, 546, 694, 670, 413, 590, 582, 670, 758, 907, 722, 566, 505, 469, 285, 618, 746, 598, 457, 349, 321, 289, 321, 397, 401, 361, 389, 377, 779, 433, 674, 746, 421, 397, 626, 670, 401, 461, 554, 795, 762, 690, 582, 618, 586, 413, 285, 610, 718, 550, 522, 441, 341, 365, 381, 437, 461, 401, 389, 469, 791, 530, 690, 738, 522, 313, 562, 622, 461, 522, 574, 923, 971, 582, 542, 526, 485, 433, 381, 578, 674, 610, 449, 349, 285, 349, 421, 449, 481, 413, 485, 546, 815, 586, 674, 766, 674, 313, 505, 554, 554, 385, 618, 694, 650, 562, 453, 453, 405, 421, 449, 686, 626, 594, 542, 437, 313, 317, 377, 405, 429, 501, 606, 578, 859, 654, 658, 734, 706, 377, 385, 626, 594, 425, 518, 473, 457, 465, 409, 461, 345, 405, 578, 473, 273, 514, 534, 301, 240, 232, 285, 409, 465, 574, 602, 562, 851, 714, 670, 694, 706, 497, 345, 566, 614, 542, 417, 309, 538, 497, 518, 590, 341, 369, 602, 530, 469, 429, 301, 257, 176, 261, 345, 534, 622, 642, 618, 606, 799, 750, 686, 698, 710, 578, 345, 477, 489, 550, 578, 281, 518, 433, 582, 738, 465, 293, 526, 550, 538, 357, 204, 208, 188, 361, 485, 654, 686, 658, 634, 598, 662, 783, 718, 710, 726, 610, 397, 526, 686, 413, 373, 321, 373, 489, 714, 766, 602, 401, 357, 349, 240, 184, 152, 96, 184, 240, 433, 578, 578, 514, 509, 481, 469, 783, 710, 714, 726, 554, 333, 602, 983, 879, 534, 538, 598, 706, 762, 779, 674, 501, 441, 244, 140, 136, 196, 232, 244, 232, 277, 289, 313, 277, 236, 220, 317, 702, 698, 706, 710, 562, 437, 847, 1015, 1011, 835, 497, 457, 497, 465, 489, 417, 273, 273, 240, 208, 200, 204, 224, 224, 204, 172, 204, 236, 192, 172, 168, 164, 385, 578, 674, 714, 662, 662, 987, 1015, 911, 441, 240, 212, 196, 196, 192, 180, 168, 184, 168, 152, 184, 184, 172, 168, 184, 184, 200, 220, 212, 204, 180, 116, 116, 236, 526, 666, 530, 779, 1019, 967, 566, 244, 200, 200, 204, 196, 200, 188, 168, 156, 136, 140, 156, 152, 168, 180, 224, 248, 236, 224, 200, 184, 204, 192, 120, 136, 293, 514, 514, 863, 1024, 750, 265, 216, 200, 208, 208, 184, 180, 172, 164, 144, 156, 160, 160, 172, 184, 236, 248, 257, 236, 216, 200, 281, 333, 208, 140, 124, 164, 265, 514, 899, 963, 497, 232, 196, 224, 216, 176, 176, 188, 184, 172, 172, 176, 176, 180, 216, 232, 216, 184, 172, 144, 204, 293, 341, 305, 200, 140, 116, 140, 176, 313, 811, 847, 389, 261, 216, 192, 232, 192, 160, 180, 188, 192, 188, 184, 204, 156, 156, 192, 188, 156, 112, 160, 269, 269, 184, 204, 200, 140, 128, 132, 164, 184, 417, 682, 257, 216, 208, 212, 244, 232, 216, 180, 168, 164, 184, 196, 184, 168, 160, 156, 148, 160, 176, 252, 188, 124, 60, 204, 273, 168, 124, 152, 148, 172, 168, 285, 196, 124, 108, 152, 196, 224, 232, 212, 224, 240, 228, 212, 200, 180, 156, 132, 168, 248, 317, 293, 224, 152, 52, 160, 244, 196, 140, 172, 156, 168, 176, 160, 168, 108, 92, 120, 108, 116, 144, 188, 224, 248, 265, 301, 277, 196, 172, 172, 240, 341, 437, 373, 240, 104, 116, 80, 216, 224, 180, 172, 160, 160, 160, 152, 144, 104, 88, 116, 100, 116, 76, 72, 128, 188, 244, 297, 265, 212, 208, 180, 269, 357, 421, 357, 192, 96, 136, 84, 449, 445, 465, 473, 449, 437, 461, 453, 445, 453, 465, 445, 445, 469, 469, 477, 469, 453, 445, 449, 437, 429, 429, 425, 429, 405, 393, 389, 389, 381, 365, 341, 449, 441, 457, 465, 449, 453, 469, 457, 465, 441, 445, 441, 453, 477, 469, 461, 461, 445, 449, 461, 441, 417, 409, 401, 421, 409, 409, 389, 393, 381, 365, 353, 441, 437, 445, 445, 425, 461, 469, 469, 461, 461, 457, 437, 445, 461, 457, 453, 465, 457, 445, 385, 361, 313, 309, 341, 345, 385, 413, 397, 397, 393, 381, 357, 429, 441, 437, 449, 441, 469, 481, 477, 461, 469, 493, 586, 522, 445, 461, 457, 449, 445, 321, 349, 361, 361, 301, 252, 281, 248, 341, 393, 409, 405, 397, 377, 429, 457, 461, 457, 457, 453, 481, 465, 453, 465, 514, 859, 626, 457, 445, 433, 321, 212, 277, 413, 441, 457, 409, 377, 289, 313, 293, 333, 385, 405, 377, 373, 437, 417, 401, 449, 461, 453, 465, 461, 445, 465, 473, 554, 489, 409, 301, 200, 232, 224, 333, 453, 485, 489, 465, 385, 401, 365, 232, 232, 337, 421, 393, 381, 401, 381, 148, 297, 469, 473, 461, 473, 469, 465, 481, 429, 393, 433, 349, 269, 333, 301, 337, 522, 570, 473, 397, 409, 445, 333, 285, 188, 244, 393, 397, 373, 461, 385, 172, 257, 445, 469, 457, 465, 477, 453, 437, 377, 441, 526, 425, 349, 381, 353, 309, 473, 614, 497, 373, 393, 373, 325, 240, 212, 188, 333, 413, 389, 646, 421, 232, 485, 497, 453, 469, 489, 485, 542, 357, 421, 566, 574, 445, 321, 325, 341, 313, 285, 501, 542, 413, 317, 309, 329, 293, 228, 140, 236, 425, 413, 706, 558, 401, 618, 598, 465, 465, 473, 722, 859, 722, 526, 614, 526, 441, 341, 337, 297, 228, 273, 501, 534, 497, 393, 325, 341, 341, 305, 196, 120, 301, 413, 734, 465, 606, 678, 626, 449, 473, 357, 791, 899, 766, 542, 638, 550, 433, 445, 305, 321, 176, 341, 662, 590, 590, 401, 333, 409, 353, 317, 236, 144, 184, 325, 766, 433, 578, 702, 670, 481, 493, 373, 381, 730, 686, 570, 646, 686, 477, 429, 393, 337, 152, 485, 807, 610, 558, 357, 321, 373, 417, 349, 301, 212, 220, 224, 779, 385, 538, 722, 626, 493, 493, 437, 273, 618, 578, 457, 666, 811, 598, 453, 457, 457, 200, 590, 750, 598, 473, 353, 333, 337, 381, 349, 349, 293, 297, 220, 771, 381, 618, 754, 441, 425, 497, 465, 289, 530, 501, 598, 698, 867, 690, 526, 469, 457, 285, 610, 726, 578, 441, 341, 321, 293, 321, 401, 405, 353, 357, 293, 787, 429, 670, 746, 437, 357, 477, 489, 297, 425, 493, 742, 722, 662, 562, 574, 546, 401, 285, 610, 702, 534, 514, 437, 345, 373, 385, 441, 465, 385, 341, 381, 791, 518, 670, 714, 550, 333, 481, 501, 377, 481, 526, 887, 947, 554, 522, 485, 449, 417, 353, 538, 638, 590, 433, 341, 289, 353, 417, 437, 441, 345, 385, 417, 815, 586, 658, 730, 682, 345, 501, 505, 485, 321, 574, 654, 610, 530, 425, 425, 405, 405, 361, 574, 554, 566, 522, 421, 305, 317, 373, 365, 333, 353, 433, 417, 863, 666, 670, 738, 730, 409, 385, 598, 550, 373, 465, 421, 409, 421, 365, 441, 365, 413, 514, 385, 224, 481, 505, 277, 224, 224, 281, 373, 377, 449, 465, 441, 847, 738, 702, 726, 738, 526, 353, 558, 594, 514, 361, 257, 485, 445, 469, 574, 369, 385, 558, 469, 437, 397, 273, 236, 164, 248, 277, 421, 477, 481, 461, 445, 771, 758, 706, 718, 730, 598, 361, 485, 497, 546, 538, 236, 473, 389, 538, 706, 473, 301, 477, 497, 518, 345, 196, 204, 196, 361, 365, 473, 485, 453, 445, 429, 626, 775, 714, 694, 726, 630, 413, 542, 702, 421, 361, 309, 361, 473, 694, 730, 594, 401, 313, 309, 244, 208, 184, 132, 228, 285, 401, 501, 493, 437, 453, 421, 481, 803, 714, 678, 718, 578, 349, 614, 991, 891, 562, 566, 626, 730, 787, 771, 690, 534, 437, 248, 196, 216, 281, 325, 341, 337, 397, 405, 417, 385, 369, 361, 421, 791, 734, 690, 710, 586, 449, 847, 1011, 1015, 899, 574, 530, 566, 534, 534, 497, 373, 349, 329, 337, 337, 341, 373, 377, 365, 385, 417, 433, 389, 389, 381, 357, 550, 674, 698, 730, 682, 666, 983, 1007, 927, 546, 353, 321, 305, 301, 289, 317, 325, 325, 329, 345, 361, 357, 349, 357, 373, 377, 385, 385, 377, 381, 361, 365, 349, 409, 614, 718, 546, 758, 1003, 983, 638, 377, 337, 337, 341, 333, 337, 345, 337, 329, 317, 333, 345, 341, 357, 369, 413, 413, 405, 409, 397, 377, 413, 445, 377, 341, 425, 594, 546, 855, 1015, 795, 373, 365, 353, 361, 361, 333, 329, 329, 325, 321, 333, 345, 357, 369, 381, 433, 441, 437, 433, 433, 421, 493, 550, 457, 397, 345, 333, 381, 582, 919, 983, 574, 369, 349, 377, 369, 329, 329, 333, 337, 333, 345, 353, 361, 389, 425, 441, 421, 389, 381, 365, 433, 522, 554, 501, 441, 393, 357, 345, 333, 425, 879, 915, 505, 417, 377, 349, 389, 349, 321, 329, 337, 349, 357, 357, 389, 369, 373, 409, 405, 373, 341, 405, 518, 505, 393, 385, 433, 389, 369, 353, 353, 337, 534, 791, 401, 389, 377, 381, 413, 401, 385, 333, 317, 321, 353, 369, 369, 381, 373, 369, 361, 373, 409, 501, 441, 361, 240, 373, 497, 401, 353, 365, 349, 357, 317, 429, 357, 309, 285, 329, 373, 401, 409, 369, 377, 397, 397, 389, 381, 377, 353, 333, 365, 449, 530, 526, 465, 389, 257, 341, 465, 409, 341, 365, 361, 369, 353, 325, 341, 289, 269, 297, 285, 293, 321, 345, 381, 405, 437, 477, 453, 381, 353, 353, 421, 522, 626, 582, 461, 329, 329, 257, 429, 421, 357, 345, 357, 369, 349, 325, 317, 277, 265, 293, 277, 293, 252, 232, 281, 349, 417, 477, 445, 385, 381, 349, 437, 526, 586, 542, 397, 309, 337, 269, 196, 188, 204, 212, 184, 164, 188, 180, 176, 164, 164, 208, 196, 164, 180, 176, 160, 152, 156, 172, 176, 180, 180, 172, 176, 156, 172, 164, 152, 144, 144, 132, 204, 160, 180, 224, 196, 172, 188, 180, 184, 152, 164, 216, 208, 164, 160, 132, 120, 132, 164, 200, 212, 220, 208, 192, 200, 184, 180, 152, 136, 124, 128, 136, 188, 132, 144, 192, 168, 176, 180, 180, 172, 172, 192, 228, 204, 152, 148, 140, 156, 188, 216, 196, 208, 200, 188, 200, 192, 220, 204, 156, 140, 136, 136, 132, 160, 128, 124, 176, 172, 184, 192, 192, 176, 180, 228, 381, 301, 164, 188, 216, 232, 269, 188, 261, 305, 337, 265, 200, 208, 156, 180, 184, 172, 156, 156, 144, 164, 192, 196, 188, 172, 160, 188, 176, 164, 168, 236, 658, 429, 224, 240, 285, 200, 124, 224, 393, 445, 473, 421, 373, 269, 281, 188, 180, 192, 184, 144, 144, 216, 257, 228, 212, 176, 156, 164, 164, 148, 156, 168, 341, 313, 232, 172, 124, 172, 180, 305, 441, 481, 489, 465, 385, 389, 345, 188, 148, 196, 232, 176, 160, 228, 321, 68, 112, 192, 172, 160, 172, 168, 148, 156, 208, 236, 301, 281, 228, 289, 257, 297, 485, 530, 433, 361, 377, 413, 309, 277, 156, 144, 232, 192, 156, 361, 369, 152, 164, 224, 168, 144, 156, 196, 204, 204, 196, 309, 429, 373, 317, 353, 329, 277, 429, 562, 449, 325, 353, 337, 297, 232, 196, 128, 200, 204, 156, 578, 421, 236, 453, 329, 172, 164, 200, 265, 381, 236, 313, 485, 514, 405, 297, 309, 329, 293, 244, 449, 493, 373, 281, 277, 305, 269, 212, 108, 140, 236, 180, 654, 574, 421, 598, 449, 204, 188, 240, 586, 795, 666, 477, 582, 501, 429, 317, 317, 285, 212, 232, 449, 489, 457, 357, 297, 313, 313, 285, 172, 60, 176, 228, 702, 489, 634, 674, 489, 200, 204, 188, 718, 907, 754, 526, 622, 530, 417, 417, 277, 309, 160, 309, 618, 550, 554, 369, 309, 385, 317, 293, 236, 132, 124, 184, 758, 465, 614, 714, 546, 236, 220, 176, 321, 754, 658, 534, 606, 638, 425, 381, 357, 317, 136, 453, 771, 570, 522, 329, 301, 353, 377, 325, 313, 220, 192, 104, 779, 421, 578, 742, 534, 273, 212, 188, 176, 610, 505, 377, 594, 734, 518, 393, 421, 437, 188, 562, 714, 562, 445, 333, 317, 321, 341, 325, 357, 293, 257, 96, 775, 413, 654, 771, 393, 265, 232, 200, 156, 481, 413, 509, 622, 803, 630, 469, 429, 437, 273, 590, 698, 546, 417, 321, 305, 281, 289, 377, 397, 325, 277, 136, 787, 449, 690, 754, 437, 269, 248, 220, 136, 353, 413, 678, 678, 638, 562, 538, 501, 381, 281, 598, 682, 509, 489, 421, 333, 365, 361, 417, 445, 321, 212, 188, 791, 546, 698, 726, 570, 309, 353, 309, 208, 373, 465, 847, 923, 550, 522, 449, 405, 381, 301, 473, 586, 554, 405, 321, 273, 349, 397, 397, 373, 216, 192, 192, 819, 642, 714, 754, 690, 361, 505, 453, 329, 148, 534, 622, 566, 469, 353, 361, 369, 349, 232, 417, 437, 505, 473, 389, 289, 309, 377, 329, 220, 180, 220, 184, 863, 722, 738, 779, 746, 421, 409, 582, 445, 244, 421, 381, 357, 357, 293, 393, 353, 381, 409, 257, 128, 421, 461, 244, 204, 212, 261, 313, 257, 273, 257, 216, 823, 771, 758, 775, 754, 534, 385, 574, 566, 445, 321, 220, 433, 385, 401, 534, 373, 373, 481, 373, 369, 345, 232, 208, 156, 240, 160, 236, 248, 216, 180, 184, 722, 750, 726, 742, 738, 610, 397, 530, 522, 542, 505, 204, 433, 345, 493, 674, 473, 293, 413, 421, 473, 313, 176, 200, 208, 373, 240, 273, 257, 208, 200, 184, 586, 750, 702, 690, 722, 642, 445, 586, 742, 445, 349, 293, 345, 465, 694, 710, 594, 405, 265, 252, 228, 216, 204, 164, 277, 333, 301, 329, 305, 244, 277, 252, 497, 803, 706, 674, 718, 590, 365, 638, 1003, 903, 578, 590, 658, 771, 835, 791, 726, 574, 437, 248, 232, 273, 349, 409, 441, 445, 489, 477, 481, 449, 449, 461, 534, 855, 771, 710, 730, 602, 453, 839, 991, 1011, 931, 630, 598, 650, 626, 610, 594, 477, 417, 405, 445, 441, 461, 501, 526, 522, 542, 566, 570, 530, 550, 530, 542, 674, 754, 754, 771, 698, 658, 951, 967, 915, 614, 445, 421, 421, 429, 405, 461, 481, 453, 465, 501, 501, 505, 514, 530, 558, 550, 550, 542, 538, 558, 534, 566, 522, 538, 706, 766, 550, 726, 971, 983, 702, 509, 473, 477, 485, 481, 465, 469, 469, 461, 453, 481, 501, 501, 522, 538, 582, 570, 570, 586, 578, 562, 598, 650, 562, 497, 546, 670, 574, 839, 999, 823, 473, 514, 501, 509, 509, 485, 461, 453, 449, 453, 469, 493, 526, 538, 554, 602, 610, 590, 598, 618, 610, 670, 730, 662, 590, 522, 489, 505, 658, 939, 991, 614, 457, 493, 526, 518, 477, 477, 477, 477, 477, 493, 509, 526, 566, 602, 618, 602, 566, 562, 554, 634, 714, 730, 678, 650, 598, 554, 534, 505, 554, 935, 939, 562, 505, 518, 497, 534, 493, 465, 477, 489, 505, 522, 530, 562, 554, 558, 594, 590, 558, 534, 614, 730, 706, 570, 558, 646, 590, 574, 566, 554, 501, 638, 847, 477, 485, 514, 522, 558, 542, 526, 481, 473, 481, 522, 542, 546, 558, 554, 546, 542, 554, 606, 714, 658, 562, 413, 546, 710, 594, 550, 586, 558, 530, 453, 534, 457, 421, 421, 469, 514, 542, 550, 514, 526, 550, 558, 554, 550, 546, 526, 501, 534, 618, 718, 726, 674, 586, 433, 509, 674, 594, 530, 574, 558, 538, 501, 449, 461, 417, 409, 437, 425, 433, 461, 481, 514, 542, 578, 626, 610, 538, 509, 509, 578, 682, 791, 762, 658, 522, 505, 429, 642, 598, 530, 538, 538, 530, 493, 461, 457, 421, 405, 433, 417, 433, 393, 357, 401, 473, 550, 610, 582, 526, 522, 493, 582, 670, 730, 702, 582, 497, 518, 441};
static dtype input_buffer3[64] = {0};

int16_t label;


void main(void){

    WDTCTL = WDTPW | WDTHOLD;   // stop watchdog timer

    // Initialize GPIO System
    init_gpio();

    // Initialize the clock and baudrate
    init_clock_system();

    inputFeatures.numRows = 32;
    inputFeatures.numCols = 32;
    inputFeatures.data = array;

    outputLabels.numRows = 10;
    outputLabels.numCols = 2;
    outputLabels.data = input_buffer3;

    apply_model(&outputLabels, &inputFeatures);
    label = argmax(&outputLabels);

    __no_operation();



}


